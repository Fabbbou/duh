name: Update Repository Metadata

on:
  release:
    types: [published]
  workflow_dispatch:  # Allow manual trigger
  push:
    branches: [main]
    paths:
      - 'README.md'
      - '.github/workflows/update-repo-meta.yml'

jobs:
  update-repo:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Update repository metadata
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const { owner, repo } = context.repo;
          
          // Extract description from README
          const fs = require('fs');
          const readme = fs.readFileSync('README.md', 'utf8');
          
          // Look for description in README (first line after title, or first paragraph)
          const lines = readme.split('\n').filter(line => line.trim());
          let description = 'Simple dotfiles manager for shell aliases and environment exports';
          
          // Try to find a better description from README
          for (let i = 0; i < lines.length; i++) {
            const line = lines[i].trim();
            if (line.startsWith('# ') && i + 1 < lines.length) {
              const nextLine = lines[i + 1].trim();
              if (nextLine && !nextLine.startsWith('#') && !nextLine.startsWith('[![')) {
                description = nextLine.replace(/^[>*-]\s*/, ''); // Remove markdown formatting
                break;
              }
            }
          }
          
          // Ensure description is not too long (350 char limit)
          if (description.length > 350) {
            description = description.substring(0, 347) + '...';
          }
          
          // Define topics
          const topics = [
            'cli',
            'dotfiles', 
            'shell',
            'aliases',
            'exports',
            'golang',
            'terminal',
            'bash',
            'zsh',
            'cross-platform',
            'environment-variables',
            'command-line'
          ];
          
          try {
            // Update repository description and topics
            await github.rest.repos.update({
              owner,
              repo,
              description,
              topics,
              has_issues: true,
              has_projects: false,
              has_wiki: false,
              has_downloads: true
            });
            
            console.log('‚úÖ Repository metadata updated successfully');
            console.log('üìù Description:', description);
            console.log('üè∑Ô∏è Topics:', topics.join(', '));
            
          } catch (error) {
            console.error('‚ùå Failed to update repository metadata:', error);
            core.setFailed(`Failed to update repository: ${error.message}`);
          }

    - name: Update repository website URL
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const { owner, repo } = context.repo;
          
          // Check if we have releases to link to
          try {
            const releases = await github.rest.repos.listReleases({
              owner,
              repo,
              per_page: 1
            });
            
            let homepage = '';
            if (releases.data.length > 0) {
              // Link to releases page if we have releases
              homepage = `https://github.com/${owner}/${repo}/releases`;
            }
            
            if (homepage) {
              await github.rest.repos.update({
                owner,
                repo,
                homepage
              });
              console.log('üîó Homepage URL updated:', homepage);
            }
            
          } catch (error) {
            console.log('‚ÑπÔ∏è Could not update homepage URL:', error.message);
          }